# 밸런스 게임 백엔드 API 협업 가이드

## 🎯 프로젝트 개요

### 시스템 구조
- **프레임워크**: Spring Boot 3.2.6 (Java 17)
- **데이터베이스**: PostgreSQL
- **ORM**: JPA + QueryDSL
- **인증**: JWT + OAuth2 (소셜 로그인)
- **파일 저장**: Azure Blob Storage
- **빌드 도구**: Gradle

### 핵심 기능
1. **밸런스 게임 플레이 시스템** - 회원/비회원 모두 게임 가능
2. **질문 생성 및 승인 시스템** - 회원이 질문 생성, 관리자 승인 후 공개
3. **8자리 공유 코드 시스템** - 게임 결과 공유 및 비교
4. **소셜 로그인** - OAuth2 기반 간편 로그인
5. **관리자 대시보드** - 질문 승인/거절 관리

---

## 🚀 API 엔드포인트 가이드

### 🎮 게임 플레이 관련 API

### 백엔드 API 주소 : https://balance-game-ekedbfhkcxeyc8cb.koreacentral-01.azurewebsites.net/api

#### 1. 게임 시작
```http
POST /api/game/start
Content-Type: application/json

# 회원 게임 시작
{
  "bundleId": 1,
  "userEmail": "user@example.com"
}

# 비회원 게임 시작
{
  "bundleId": 1,
  "tempUserId": "temp-unique-id-123"
}

# 공유 코드로 비교 게임 시작
{
  "bundleId": 1,
  "shareCode": "ABC12345",
  "tempUserId": "temp-unique-id-456"
}
```

**응답**:
```json
{
  "sessionId": 123,
  "bundleId": 1,
  "bundleTitle": "연애 밸런스 게임",
  "totalQuestions": 10,
  "questions": [
    {
      "questionId": 1,
      "text": "첫 데이트 장소는?",
      "optionAText": "영화관",
      "optionBText": "카페",
      "optionAImageUrl": "https://...",
      "optionBImageUrl": "https://..."
    }
  ]
}
```

#### 2. 답변 제출
```http
POST /api/game/answer
Content-Type: application/json

{
  "sessionId": 123,
  "questionId": 1,
  "selectedOption": "A"  // A 또는 B
}
```

#### 3. 게임 완료 및 공유코드 받기
```http
POST /api/game/sessions/123/complete
```

**응답**:
```json
{
  "shareCode": "ABC12345"
}
```

#### 4. 게임 결과 조회
```http
GET /api/game/sessions/123/results
```

**응답**:
```json
{
  "sessionId": 123,
  "bundleTitle": "연애 밸런스 게임",
  "shareCode": "ABC12345",
  "userChoices": {
    "1": "A",
    "2": "B",
    "3": "A"
  },
  "totalQuestions": 10
}
```

#### 5. 공유코드로 세션 조회
```http
GET /api/game/share/ABC12345
```

#### 6. 결과 비교
```http
POST /api/game/compare?shareCode=ABC12345&compareSessionId=456
```

**응답**:
```json
{
  "originalSessionId": 123,
  "compareSessionId": 456,
  "bundleTitle": "연애 밸런스 게임",
  "matchRate": 70.0,
  "matchCount": 7,
  "totalQuestions": 10,
  "comparisons": {
    "1": {
      "questionId": 1,
      "originalChoice": "A",
      "compareChoice": "A",
      "isMatch": true
    }
  }
}
```

### 📝 질문 관리 API

#### 질문 생성 (회원 전용)
```http
POST /api/questions
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "text": "아침형 인간 vs 저녁형 인간",
  "optionAText": "아침형 인간",
  "optionBText": "저녁형 인간", 
  "keyword": "라이프스타일",
  "optionAImageUrl": "https://example.com/image1.jpg",
  "optionBImageUrl": "https://example.com/image2.jpg"
}
```

#### 질문 묶음 조회
```http
GET /api/question-bundles?page=0&size=20&keyword=연애
```

#### 인기 질문 조회
```http
GET /api/questions/popular?page=0&size=20
```

### 🔐 인증 API

#### 로그인
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**응답**:
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userInfo": {
    "id": 1,
    "email": "user@example.com",
    "nickname": "사용자닉네임",
    "role": "USER"
  }
}
```

#### 회원가입
```http
POST /api/auth/signup
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123",
  "nickname": "사용자닉네임"
}
```

### 👤 마이페이지 API

#### 내 게임 기록 조회
```http
GET /api/my/game-history?page=0&size=10
Authorization: Bearer {access_token}
```

#### 내 질문 조회
```http
GET /api/my/questions?status=PENDING&page=0&size=10
Authorization: Bearer {access_token}
```

#### 내 통계 조회
```http
GET /api/my/stats
Authorization: Bearer {access_token}
```

---

## 📊 데이터베이스 구조

### 핵심 엔티티

#### User (사용자)
```sql
user_id         BIGINT PRIMARY KEY
email           VARCHAR(255) UNIQUE
nickname        VARCHAR(50) UNIQUE NOT NULL
password        VARCHAR(255)
provider        VARCHAR(50)         -- OAuth 제공자
provider_id     VARCHAR(255)        -- OAuth ID
role            VARCHAR(20)         -- USER, ADMIN
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

#### Question (질문)
```sql
question_id         BIGINT PRIMARY KEY
text               VARCHAR(500) NOT NULL
option_a_text      VARCHAR(255) NOT NULL
option_b_text      VARCHAR(255) NOT NULL
keyword            VARCHAR(50)
creator_id         BIGINT               -- User 참조
approval_status    VARCHAR(20)          -- PENDING, APPROVED, REJECTED
rejection_reason   VARCHAR(500)
approved_by        BIGINT               -- User 참조 (관리자)
approved_at        TIMESTAMP
option_a_image_url VARCHAR(2048)
option_b_image_url VARCHAR(2048)
is_active          BOOLEAN DEFAULT true
created_at         TIMESTAMP
updated_at         TIMESTAMP
```

#### GameSession (게임 세션)
```sql
session_id              BIGINT PRIMARY KEY
bundle_id               BIGINT NOT NULL     -- QuestionBundle 참조
player_user_id          BIGINT              -- User 참조 (회원인 경우)
temp_user_id           VARCHAR(50)         -- 비회원 식별자
share_code             VARCHAR(8) UNIQUE   -- 공유 코드
share_code_created_at  TIMESTAMP
share_code_expires_at  TIMESTAMP
parent_session_id      BIGINT              -- 비교 대상 세션
session_status         VARCHAR(20)         -- IN_PROGRESS, COMPLETED, EXPIRED
created_at             TIMESTAMP
completed_at           TIMESTAMP
```

#### UserAnswer (사용자 답변)
```sql
answer_id     BIGINT PRIMARY KEY
session_id    BIGINT NOT NULL      -- GameSession 참조
question_id   BIGINT NOT NULL      -- Question 참조
selected_option CHAR(1) NOT NULL   -- 'A' 또는 'B'
answered_at   TIMESTAMP
```

---

## 🔒 권한 체계

### 역할별 권한

#### 비회원 (ANONYMOUS)
- ✅ 게임 플레이
- ✅ 질문 묶음 조회
- ✅ 공유 코드로 결과 비교
- ❌ 질문 생성
- ❌ 마이페이지 접근

#### 일반 회원 (USER)
- ✅ 모든 비회원 권한
- ✅ 질문 생성 요청 (승인 대기)
- ✅ 질문 묶음 생성
- ✅ 마이페이지 접근
- ✅ 게임 기록 저장/조회

#### 관리자 (ADMIN)
- ✅ 모든 일반 회원 권한
- ✅ 질문 승인/거절
- ✅ 관리자 대시보드 접근
- ✅ 사용자 관리

### JWT 토큰 인증
```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## 🎯 프론트엔드 연동 가이드

### 1. 비회원 게임 플레이 플로우

```javascript
// 1. 임시 사용자 ID 생성
const tempUserId = 'temp-' + Math.random().toString(36).substr(2, 9);

// 2. 게임 시작
const startResponse = await fetch('/api/game/start', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    bundleId: 1,
    tempUserId: tempUserId
  })
});
const gameSession = await startResponse.json();

// 3. 질문별 답변 제출
for (let question of gameSession.questions) {
  await fetch('/api/game/answer', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      sessionId: gameSession.sessionId,
      questionId: question.questionId,
      selectedOption: 'A' // 사용자 선택
    })
  });
}

// 4. 게임 완료 및 공유코드 받기
const completeResponse = await fetch(`/api/game/sessions/${gameSession.sessionId}/complete`, {
  method: 'POST'
});
const shareCodeData = await completeResponse.json();
console.log('공유코드:', shareCodeData.shareCode);
```

### 2. 회원 로그인 및 토큰 관리

```javascript
// 로그인
const loginResponse = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'password123'
  })
});
const authData = await loginResponse.json();

// 토큰 저장
localStorage.setItem('accessToken', authData.accessToken);
localStorage.setItem('refreshToken', authData.refreshToken);

// 인증이 필요한 API 호출 시
const response = await fetch('/api/my/stats', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
  }
});
```

### 3. 공유코드 비교 플로우

```javascript
// 1. 공유코드로 원본 세션 정보 조회
const originalSession = await fetch(`/api/game/share/${shareCode}`);
const originalData = await originalSession.json();

// 2. 같은 묶음으로 새 게임 시작
const compareGameResponse = await fetch('/api/game/start', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    bundleId: originalData.bundleId,
    shareCode: shareCode,
    tempUserId: 'temp-' + Math.random().toString(36).substr(2, 9)
  })
});

// 3. 게임 완료 후 비교
const comparison = await fetch(`/api/game/compare?shareCode=${shareCode}&compareSessionId=${newSessionId}`, {
  method: 'POST'
});
const comparisonResult = await comparison.json();
```

---

## 🚨 에러 처리

### HTTP 상태 코드
- **200 OK**: 요청 성공
- **201 Created**: 리소스 생성 성공  
- **400 Bad Request**: 잘못된 요청 데이터
- **401 Unauthorized**: 인증 필요
- **403 Forbidden**: 권한 없음
- **404 Not Found**: 리소스를 찾을 수 없음
- **500 Internal Server Error**: 서버 오류

### 에러 응답 형식
```json
{
  "status": 400,
  "error": "Bad Request",
  "message": "필수 필드가 누락되었습니다.",
  "timestamp": "2024-01-15T10:30:00",
  "path": "/api/game/start"
}
```

### 프론트엔드 에러 처리 예시
```javascript
try {
  const response = await fetch('/api/game/start', options);
  
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(errorData.message || '요청에 실패했습니다.');
  }
  
  return await response.json();
} catch (error) {
  console.error('API 오류:', error.message);
  // 사용자에게 에러 메시지 표시
  alert(error.message);
}
```

---

## 📈 성능 최적화 고려사항

### 1. 페이징 처리
모든 목록 조회 API는 페이징을 지원합니다:
```javascript
// 질문 목록 조회 시
const response = await fetch('/api/questions/popular?page=0&size=20');
```

### 2. 이미지 최적화
- 이미지는 Azure Blob Storage에 저장
- 적절한 크기로 리사이징 후 업로드 권장
- CDN을 통한 빠른 이미지 로딩

### 3. 캐싱 전략
- 인기 질문은 Redis 캐시 활용
- 정적 데이터(키워드 등)는 클라이언트 캐싱 권장

---

## 🔧 개발 환경 설정

### 로컬 개발 서버 실행
```bash
# 데이터베이스 실행 (Docker)
docker-compose up -d

# 백엔드 서버 실행
./gradlew bootRun
```

### CORS 설정
현재 모든 origin에서 접근 가능하도록 설정되어 있습니다:
```java
@CrossOrigin(origins = "*")
```

### 환경변수 설정
`application-secret.yml` 파일에 다음 설정이 필요합니다:
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/balance_game
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    
jwt:
  secret: ${JWT_SECRET}
  
azure:
  storage:
    connection-string: ${AZURE_STORAGE_CONNECTION_STRING}
```

---

## 🔄 배포 및 CI/CD

### Azure 배포 파이프라인
- GitHub Actions을 통한 자동 배포
- `azure-pipelines.yml` 파일로 배포 설정 관리
- PostgreSQL 데이터베이스는 Azure Database for PostgreSQL 사용

### 배포 체크리스트
- [ ] 환경변수 설정 확인
- [ ] 데이터베이스 마이그레이션 실행
- [ ] CORS 설정 프로덕션 환경에 맞게 수정
- [ ] JWT 시크릿 키 보안 설정
- [ ] Azure Storage 연결 확인

---

## 📞 문의 및 협업

### API 테스트
- Postman 컬렉션 제공 가능
- Swagger UI: `/swagger-ui.html` (개발 환경)

### 개발 진행 상황
- 현재 모든 핵심 API 구현 완료
- 관리자 기능 일부 추가 개발 중
- 성능 최적화 및 보안 강화 진행 중

이 문서를 기반으로 프론트엔드 개발을 진행하시면 됩니다. 추가 질문이나 API 수정 요청이 있으시면 언제든 말씀해 주세요! 🚀